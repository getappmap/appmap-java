#!/usr/bin/env bash

fixture_dir=$PWD/build/fixtures
mkdir -p build/fixtures

source "test/helper.bash"
export ANNOTATION_JAR="$(find_annotation_jar)"

function install_petclinic (
  local repo="$1"; shift
  local ref=${1:-main}
  local pkg="$(basename $repo)"

  if [[ -d "build/fixtures/${pkg}" ]]; then
    echo "Fixture already exists: ${pkg}"
    return
  fi

  cd build/fixtures

  rm -rf "${pkg}"

  if [[ "${#ref}" == 40 ]]; then
    # It's a commit hash, download archive
    echo "Downloading archive for ${repo} at commit ${ref}"
    curl -L "https://github.com/${repo}/archive/${ref}.tar.gz" | tar xz
    mv "${pkg}-${ref}" "${pkg}"
    cd "${pkg}"
    # The archive doesn't include git history, but the tests rely on it for
    # metadata. We create a fresh git repo to satisfy the tests.
    git init
    git config user.email "test@example.com"
    git config user.name "Test User"
    git remote add origin "https://github.com/${repo}.git"
    git add .
    git commit -m "Initial commit"
  else
    # It's a branch, use git clone
    echo "Cloning ${repo} at branch ${ref}"
    git clone https://github.com/"${repo}".git --depth 1 --branch "${ref}"
    cd "${pkg}"
  fi


  cd ../../..
)

function install_scala_test_app {
  if [[ -d "test/scala/play-samples" ]]; then
    echo "Fixture already exists: play-samples"
    return
  fi
  cd test/scala
  rm -rf play-samples
  local branch=3.0.x
  case "${JAVA_VERSION}" in
    1.8*)
      branch=2.8.x
      ;;
    11.*)
      branch=2.9.x
      ;;
  esac
  git clone --no-checkout https://github.com/playframework/play-samples.git --depth 1 --branch $branch
  cd play-samples
  git sparse-checkout set play-scala-rest-api-example
  git checkout
  cp ../logback-test.xml play-scala-rest-api-example/conf/.
  cd ../../..
}

case "${JAVA_VERSION}" in
  1.8*|11.*)
    install_petclinic "land-of-apps/spring-petclinic" old-java-support
    ;;
  17.*|21.*)
    # The spring-petclinic main branch now requires Java 25. This is the last commit that supports Java 17.
    install_petclinic "spring-projects/spring-petclinic" "3aa79e3944ab1b626288f5d0629e61643ab8fb4a"
    install_petclinic "spring-petclinic/spring-framework-petclinic"
    ;;
  *) # For Java 25+
    install_petclinic "spring-projects/spring-petclinic" "main"
    install_petclinic "spring-petclinic/spring-framework-petclinic"
    ;;
esac

patch -N -p1 -d build/fixtures/spring-petclinic < test/petclinic/pom.patch


install_scala_test_app
